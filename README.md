# 1 PWM简介
## 1.1 关于PWM
- 含义
PWM（Pulse Width Modulation）即脉冲宽度调制，简称脉宽调制。它是利用微处理器的数字输出来对模拟电路进行控制的一种非常有效的技术；它是一种模拟控制方式，根据相应载荷的变化来调制晶体管基极或MOS管栅极的偏置，来实现晶体管或MOS管导通时间的改变，从而实现开关稳压电源输出的改变。
- 基本原理
PWM就是对逆变电路开关器件的通断进行控制，使输出端得到一系列幅值相等的脉冲，用这些脉冲来代替正弦波或所需要的波形。也可以这样理解，PWM是一种对模拟信号电平进行数字编码的方法。通过高分辨率计数器的使用，方波的占空比被调制用来对一个具体模拟信号的电平进行编码。PWM信号仍然是数字的，因为在给定的任何时刻，满幅值的直流供电要么完全有(ON)，要么完全无(OFF)。电压或电流源是以一种通(ON)或断(OFF)的重复脉冲序列被加到模拟负载上去的。只要带宽足够，任何模拟值都可以使用 PWM 进行编码。
- 优点及应用范围
由于其控制简单、灵活和动态响应好等优点而成为电力电子技术应用最广泛的控制方式，其应用领域包括测量，通信， 功率控制与变换，电动机控制、伺服控制、调光、开关电源，甚至某些音频放大器，因此学习PWM具有十分重要的现实意义。

## 1.2 STM32上的PWM
- PWM产生
STM32的定时器除了TIM6和7，其他的定时器都可以用来产生PWM输出。其中高级定时器TIM1和TIM8可以同时产生多达 7 路的 PWM 输出。而通用定时器也能同时产生多达 4路的 PWM 输出，这样，STM32 最多可以同时产生 30 路 PWM 输出。
脉冲宽度调制模式可以产生一个由`TIMx_ARR`寄存器确定频率、由`TIMx_CCRx`寄存器确定占空比的信号。通用定时器产生PWM 的定时器框图如下：（其他定时器框图类似）

![在这里插入图片描述](https://img-blog.csdnimg.cn/2030d421f42143c1a189aba89bb42e7b.png)


- PWM相关寄存器
包含三个寄存器：`捕获/比较模式寄存器`（TIMx_CCMR1/2）、`捕获/比较使能寄存器`（TIMx_CCER）、`捕获/比较寄存器`（TIMx_CCR1~4）。设置TIMx_CCMRx寄存器OCxPE位以使能相应的预装载寄存器，最后还要设置TIMx_CR1寄存器的ARPE位，(在向上计数或中心对称模式中)使能自动重装载的预装载寄存器。在TIMx_CCMRx寄存器中的OCxM位写入110(PWM模式1)或`111`(PWM模式2)，能够独立地设置每个OCx输出通道产生一路PWM。

	- 捕获/比较模式寄存器（TIMx_CCMRx）
下图为`TIMx_CCMR1`寄存器的各位描述：
这里需要使用的是模式设置位OCxM，总共有两种PWM模式，这两种PWM 模式的区别就是输出电平的极性相反。
![在这里插入图片描述](https://img-blog.csdnimg.cn/4d7edc477db548368dcbbc6abb5fda7e.png)
这里需要使用的是模式设置位OCxM，总共有两种PWM模式，这两种PWM 模式的区别就是输出电平的极性相反。





	- 捕获/比较使能寄存器（TIMx_CCER）
下图为TIMx_CCER寄存器的各位描述：
![在这里插入图片描述](https://img-blog.csdnimg.cn/34c0a68bb951416d87b878c7bb5803cb.png)
该寄存器控制着各个输入输出通道的开关。这里只用到了CC2E位，该位是输入/捕获 2 输出使能位，要想PWM 从 I/O 口输出，这个位必须设置为 1。
	- 捕获/比较寄存器（TIMx_CCRx）
下图为TIMx_CCR1寄存器的各位描述：
![在这里插入图片描述](https://img-blog.csdnimg.cn/09d38b48f3394d039fb034660a62f519.png)
在输出模式下，该寄存器的值与 CNT 的值比较，根据比较结果在OC1端口上产生输出信号。利用这点，我们通过修改这个寄存器的值实现控制 PWM 的输出脉宽。
